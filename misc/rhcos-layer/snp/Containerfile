# Use 4.19 dev preview as the base
# 4.19.0-ec.4 release image: quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:309fb3060b50e0098deb156a1b42ab96c9b2edbb053d704ace00ef047a3e337f

ARG OCP_RELEASE_IMAGE

FROM $OCP_RELEASE_IMAGE

COPY snp/centos-snp.repo /etc/yum.repos.d

WORKDIR /

# Install qemu
RUN rpm-ostree install qemu-kvm 

# Install Kata-containers rpm
COPY snp/rpms/ /
RUN rpm-ostree install kata-containers-3.14.0-1.rhaos4.19.el9.x86_64.rpm 

# Selinux adjustments to provide access to sev
RUN setsebool -P container_use_devices 1

RUN rpm-ostree cleanup -m && \
    ostree container commit
