# Use 4.18 as the base
# 4.18.7 release image : quay.io/openshift-release-dev/ocp-v4.0-art-dev@sha256:66d827b7f70729ca9dc6f7a2358df8fb37c82380cf36ca9653efff8605cf3a82

ARG OCP_RELEASE_IMAGE

FROM $OCP_RELEASE_IMAGE

COPY snp/centos-snp.repo /etc/yum.repos.d

WORKDIR /

# Use RH 9.6 kernel
COPY snp/rpms/ /
RUN rpm-ostree override replace kernel-{,core-,modules-,modules-core-,modules-extra-}5.14.0-570.4.1.el9_6.x86_64.rpm
 
# Install qemu
RUN rpm-ostree install qemu-kvm 

# Install Kata-containers rpm
RUN rpm-ostree install kata-containers-3.15.0-1.rhaos4.19.el9.x86_64.rpm 

# Selinux adjustments to provide access to sev
RUN setsebool -P container_use_devices 1

RUN rpm-ostree cleanup -m && \
    ostree container commit
